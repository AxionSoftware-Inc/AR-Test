<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebXR Auto-Place 6DoF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: black; }
        /* "Start AR" tugmasi */
        #enter-ar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 12px 24px; border: 1px solid white; border-radius: 4px;
            background: rgba(0, 0, 0, 0.5); color: white; font-size: 16px;
            z-index: 999; cursor: pointer;
        }
    </style>
</head>
<body>

<button id="enter-ar">START AR (Auto Place)</button>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

    let camera, scene, renderer;
    let model;

    // 1. SAHNA SOZLAMALARI
    function init() {
        const container = document.createElement('div');
        document.body.appendChild(container);

        scene = new THREE.Scene();

        // üí° MUHIM: Kamera pozitsiyasi 0,0,0 da turadi, WebXR buni o'zi boshqaradi.
        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        // üí° MUHIM: Yorug'lik (Modelsiz qorong'u bo'lib qolmasligi uchun)
        const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
        light.position.set(0.5, 1, 0.25);
        scene.add(light);

        // 2. RENDERER (Eng muhim joyi shu yerda)
        renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            alpha: true // ‚ö†Ô∏è KAMERA KO'RINISHI UCHUN SHART (Orqa fon shaffof bo'ladi)
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true; // WebXR ni yoqamiz
        container.appendChild(renderer.domElement);

        // 3. MODEL YUKLASH (Yoki test uchun kub)
        // Hozircha test uchun Yashil Kub yaratamiz. 
        // Agar o'z modeling bo'lsa, pastdagi "loadModel" funksiyasini ishlatasan.
        createTestObject(); 
        // loadRealModel('model.glb'); // <-- O'z modeling bo'lsa buni ochib qo'y

        // Tugma bosilganda
        document.getElementById('enter-ar').addEventListener('click', startARSesseion);
    }

    // TEST UCHUN OBYEKT (Yashil Kub)
    function createTestObject() {
        const geometry = new THREE.BoxGeometry(0.5, 0.5, 0.5); // 50sm kub
        const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
        model = new THREE.Mesh(geometry, material);

        // üìç JOYLASHTIRISH:
        // x = 0 (o'rta)
        // y = 0 (ko'z balandligi darajasida, biroz pastroq bo'lishi mumkin)
        // z = -2 (bizdan 2 metr oldinda)
        model.position.set(0, 0, -2); 
        
        scene.add(model);
    }

    // HAQIQIY MODEL YUKLASH UCHUN FUNKSIYA
    function loadRealModel(url) {
        const loader = new GLTFLoader();
        loader.load(url, (gltf) => {
            model = gltf.scene;
            // O'lchamini to'g'irlash (masalan 0.5 marta kichraytirish)
            model.scale.set(0.5, 0.5, 0.5); 
            // Bizdan 2 metr oldinga qo'yish
            model.position.set(0, -0.5, -2); 
            scene.add(model);
        });
    }

    // 4. WEBXR SESSIYANI BOSHLASH
    async function startARSesseion() {
        if (!navigator.xr) {
            alert("WebXR qo'llab quvvatlanmaydi");
            return;
        }

        const session = await navigator.xr.requestSession('immersive-ar', {
            requiredFeatures: ['local'] // 'local' = 6DoF tracking
        });

        renderer.xr.setReferenceSpaceType('local');
        renderer.xr.setSession(session);

        document.getElementById('enter-ar').style.display = 'none'; // Tugmani yashirish
        
        // Render loop
        renderer.setAnimationLoop(render);
    }

    function render() {
        renderer.render(scene, camera);
    }

    // Oyna o'lchami o'zgarsa
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    init();
</script>

</body>
</html>