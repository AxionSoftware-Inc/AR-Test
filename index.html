<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebXR Manual Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: black; }
        
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Bosishlarni o'tkazib yuboradi */
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            z-index: 10;
        }

        #start-btn {
            pointer-events: auto; /* Faqat tugma bosiladi */
            padding: 15px 30px; font-size: 18px; 
            background: white; border: none; border-radius: 5px; margin-bottom: 50px;
        }

        #debug {
            position: fixed; top: 10px; left: 10px; color: yellow; 
            font-family: monospace; font-size: 14px; background: rgba(0,0,0,0.5); padding: 5px;
        }
    </style>
</head>
<body>

<div id="debug">Holat: Kutilyapti...</div>

<div id="overlay">
    <button id="start-btn">AR BOSHLASH</button>
</div>

<script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';

    let camera, scene, renderer;
    let model;
    const debugDiv = document.getElementById('debug');

    function log(msg) {
        debugDiv.innerText = "Log: " + msg;
    }

    document.getElementById('start-btn').addEventListener('click', initAR);

    async function initAR() {
        if (!navigator.xr) {
            alert("WebXR topilmadi");
            return;
        }

        log("Sessiya so'ralyapti...");

        // 1. SETUP
        const container = document.createElement('div');
        document.body.appendChild(container);

        scene = new THREE.Scene();
        // FONI YO'Q QILAMIZ (Eng muhimi)
        scene.background = null; 

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

        // Yorug'lik
        const light = new THREE.AmbientLight(0xffffff, 1); 
        scene.add(light);
        const dirLight = new THREE.DirectionalLight(0xffffff, 2);
        dirLight.position.set(0, 5, 0);
        scene.add(dirLight);

        // 2. RENDERER (Manual rejim)
        renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            alpha: true // SHART
        });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        
        // ðŸš¨ MUHIM O'ZGARISH: Three.js avtomatik tozalashni o'chiramiz
        renderer.autoClear = false; 

        container.appendChild(renderer.domElement);

        // 3. MODEL (Yoki Test Kubi)
        // Test uchun qizil kub (agar model yuklanmasa ham ko'rinishi uchun)
        const geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);
        const material = new THREE.MeshStandardMaterial({ color: 0xff0000 });
        model = new THREE.Mesh(geometry, material);
        model.position.set(0, 0, -1.5); // 1.5 metr oldinda
        scene.add(model);

        // Agar haqiqiy model bo'lsa, buni ochib qo'y:
        /*
        const loader = new GLTFLoader();
        loader.load('model.glb', (gltf) => {
            scene.remove(model); // Kubni o'chiramiz
            model = gltf.scene;
            model.position.set(0, -0.5, -1.5);
            model.scale.set(0.5, 0.5, 0.5);
            scene.add(model);
        });
        */

        // 4. SESSIYA
        try {
            const session = await navigator.xr.requestSession('immersive-ar', {
                requiredFeatures: ['local'],
                optionalFeatures: ['dom-overlay'],
                domOverlay: { root: document.getElementById('overlay') }
            });

            renderer.xr.setReferenceSpaceType('local');
            renderer.xr.setSession(session);

            document.getElementById('start-btn').style.display = 'none';
            log("AR boshlandi!");

            // 5. RENDER LOOP (Qo'lda chizish)
            renderer.setAnimationLoop(() => {
                // Sening raw kodingdagi kabi majburan tozalaymiz
                renderer.clear(); 
                
                // Modelni aylantiramiz
                if(model) {
                    model.rotation.y += 0.01;
                }

                renderer.render(scene, camera);
            });

        } catch (e) {
            log("Xatolik: " + e.message);
            alert("Xato: " + e.message);
        }
    }
</script>
</body>
</html>